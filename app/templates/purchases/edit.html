{% extends "purchases/base.html" %}

{% block purchases_title %}Editar Orden de Compra: {{ order.id_purchase_order }}{% endblock %}

{% block purchases_content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit"></i> Editar Orden de Compra: {{ order.id_purchase_order }}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('purchases.purchase_edit', order_id=order.id_purchase_order) }}" id="purchaseForm">
                    <!-- Información General -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="id_purchase_order" class="form-label">ID Orden de Compra *</label>
                            <input type="text" class="form-control" id="id_purchase_order" name="id_purchase_order" 
                                   value="{{ order.id_purchase_order }}" required maxlength="50" readonly>
                            <div class="form-text">Identificador único de la orden (no editable)</div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="id_supplier" class="form-label">Proveedor *</label>
                            <select class="form-select" id="id_supplier" name="id_supplier" required 
                                    {% if order.status == 'Recibida' or order.status == 'Cancelada' %}disabled{% endif %}>
                                <option value="">Seleccionar proveedor...</option>
                                {% for supplier in suppliers %}
                                    <option value="{{ supplier.id_suplier }}" 
                                            {% if order.id_supplier == supplier.id_suplier %}selected{% endif %}>
                                        {{ supplier.name }} ({{ supplier.id_suplier }})
                                    </option>
                                {% endfor %}
                            </select>
                            {% if order.status == 'Recibida' or order.status == 'Cancelada' %}
                            <input type="hidden" name="id_supplier" value="{{ order.id_supplier }}">
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <label for="currency" class="form-label">Moneda *</label>
                            <select class="form-select" id="currency" name="currency" required
                                    {% if order.status == 'Recibida' or order.status == 'Cancelada' %}disabled{% endif %}>
                                <option value="">Seleccionar moneda...</option>
                                {% for currency in currencies %}
                                    <option value="{{ currency.symbol }}" 
                                            {% if order.currency == currency.symbol %}selected{% endif %}>
                                        {{ currency.name }} ({{ currency.symbol }})
                                    </option>
                                {% endfor %}
                            </select>
                            {% if order.status == 'Recibida' or order.status == 'Cancelada' %}
                            <input type="hidden" name="currency" value="{{ order.currency }}">
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <label for="issue_date" class="form-label">Fecha Emisión *</label>
                            <input type="date" class="form-control" id="issue_date" name="issue_date" 
                                   value="{{ order.issue_date.strftime('%Y-%m-%d') }}" required
                                   {% if order.status == 'Recibida' or order.status == 'Cancelada' %}readonly{% endif %}>
                        </div>

                        <div class="col-md-4">
                            <label for="estimated_delivery_date" class="form-label">Fecha Entrega Estimada *</label>
                            <input type="date" class="form-control" id="estimated_delivery_date" name="estimated_delivery_date" 
                                   value="{{ order.estimated_delivery_date.strftime('%Y-%m-%d') }}" required
                                   {% if order.status == 'Recibida' or order.status == 'Cancelada' %}readonly{% endif %}>
                        </div>

                        <div class="col-md-4">
                            <label for="status" class="form-label">Estado *</label>
                            {% if order.status == 'Recibida' %}
                                <!-- Solo mostrar Cancelada como opción cuando el estado actual es Recibida -->
                                <select class="form-select" id="status" name="status" required>
                                    <option value="Recibida" selected>Recibida</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                                <div class="form-text text-warning">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    La orden ya ha sido recibida. Solo puede cambiar el estado a "Cancelada".
                                </div>
                            {% elif order.status == 'Cancelada' %}
                                <!-- No permitir cambios si ya está cancelada -->
                                <input type="text" class="form-control bg-light" value="Cancelada" readonly>
                                <input type="hidden" name="status" value="Cancelada">
                                <div class="form-text text-danger">
                                    <i class="fas fa-ban"></i> 
                                    La orden está cancelada y no puede ser modificada.
                                </div>
                            {% else %}
                                <!-- Mostrar todas las opciones para otros estados -->
                                <select class="form-select" id="status" name="status" required>
                                    <option value="Pendiente" {% if order.status == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                                    <option value="Aprobada" {% if order.status == 'Aprobada' %}selected{% endif %}>Aprobada</option>
                                    <option value="Enviada" {% if order.status == 'Enviada' %}selected{% endif %}>Enviada</option>
                                    <option value="Recibida" {% if order.status == 'Recibida' %}selected{% endif %}>Recibida</option>
                                    <option value="Cancelada" {% if order.status == 'Cancelada' %}selected{% endif %}>Cancelada</option>
                                </select>
                            {% endif %}
                        </div>

                        <div class="col-12">
                            <label for="notes" class="form-label">Notas</label>
                            <textarea class="form-control" id="notes" name="notes" 
                                      rows="3" placeholder="Notas adicionales..."
                                      {% if order.status == 'Cancelada' %}readonly{% endif %}>{{ order.notes or '' }}</textarea>
                        </div>
                    </div>

                    <!-- Líneas de la Orden -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-list"></i> Líneas de la Orden
                                </h6>
                                {% if order.status != 'Recibida' and order.status != 'Cancelada' %}
                                <button type="button" class="btn btn-sm btn-success" id="addLineBtn">
                                    <i class="fas fa-plus"></i> Agregar Línea
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-sm btn-success" id="addLineBtn" disabled>
                                    <i class="fas fa-plus"></i> Agregar Línea
                                </button>
                                <span class="text-muted ms-2">Las líneas no pueden modificarse en este estado</span>
                                {% endif %}
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" id="linesTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="20%">Material *</th>
                                            <th width="10%">Cantidad *</th>
                                            <th width="15%">Unidad *</th>
                                            <th width="15%">Precio Unitario *</th>
                                            <th width="15%">Moneda *</th>
                                            <th width="15%">Subtotal</th>
                                            {% if order.status != 'Recibida' and order.status != 'Cancelada' %}
                                            <th width="5%">Acciones</th>
                                            {% endif %}
                                        </tr>
                                    </thead>
                                    <tbody id="linesBody">
                                        {% for line in lines %}
                                        <tr id="line_{{ loop.index }}">
                                            <td>{{ loop.index }}</td>
                                            <td>
                                                <select class="form-select material-select" name="id_material_{{ loop.index }}" required
                                                        {% if order.status == 'Recibida' or order.status == 'Cancelada' %}disabled{% endif %}>
                                                    <option value="">Seleccionar material...</option>
                                                    {% for material in materials %}
                                                        <option value="{{ material.id_material }}" data-unit="{{ material.unit }}"
                                                                {% if line.id_material == material.id_material %}selected{% endif %}>
                                                            {{ material.id_material }} - {{ material.name }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <input type="number" class="form-control quantity" name="quantity_{{ loop.index }}" 
                                                       min="1" value="{{ line.quantity }}" required
                                                       {% if order.status == 'Recibida' or order.status == 'Cancelada' %}readonly{% endif %}>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control unit" name="unit_material_{{ loop.index }}" 
                                                       value="{{ line.unit_material }}" readonly required>
                                            </td>
                                            <td>
                                                <input type="number" class="form-control price" name="price_{{ loop.index }}" 
                                                       step="0.01" min="0" value="{{ line.price }}" required
                                                       {% if order.status == 'Recibida' or order.status == 'Cancelada' %}readonly{% endif %}>
                                            </td>
                                            <td>
                                                <select class="form-select currency" name="currency_suppliers_{{ loop.index }}" required
                                                        {% if order.status == 'Recibida' or order.status == 'Cancelada' %}disabled{% endif %}>
                                                    <option value="">Seleccionar...</option>
                                                    {% for currency in currencies %}
                                                        <option value="{{ currency.symbol }}"
                                                                {% if line.currency_suppliers == currency.symbol %}selected{% endif %}>
                                                            {{ currency.symbol }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <span class="subtotal">{{ "%.2f"|format(line.quantity * line.price) }}</span>
                                            </td>
                                            {% if order.status != 'Recibida' and order.status != 'Cancelada' %}
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger remove-line" 
                                                        data-line="{{ loop.index }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                            {% endif %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="{% if order.status != 'Recibida' and order.status != 'Cancelada' %}7{% else %}6{% endif %}" 
                                                class="text-end"><strong>Total:</strong></td>
                                            <td><strong id="totalAmount">{{ "%.2f"|format(order.total_amount) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <input type="hidden" id="line_count" name="line_count" value="{{ lines|length }}">
                            {% if order.status == 'Cancelada' %}
                            <button type="button" class="btn btn-primary" disabled>
                                <i class="fas fa-ban"></i> Orden Cancelada - No Editable
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save"></i> Actualizar Orden de Compra
                            </button>
                            {% endif %}
                            <a href="{{ url_for('purchases.purchase_detail', order_id=order.id_purchase_order) }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Sistema de gestión de líneas de orden de compra
class PurchaseOrderLines {
    constructor() {
        this.lineCounter = {{ lines|length }};
        this.linesBody = document.getElementById('linesBody');
        this.lineCountInput = document.getElementById('line_count');
        this.totalAmountElement = document.getElementById('totalAmount');
        this.submitBtn = document.getElementById('submitBtn');
        
        this.init();
    }
    
    init() {
        // Solo inicializar eventos si la orden no está en estado Recibida o Cancelada
        const currentStatus = "{{ order.status }}";
        if (currentStatus !== 'Recibida' && currentStatus !== 'Cancelada') {
            // Event listener para el botón de agregar línea
            const addLineBtn = document.getElementById('addLineBtn');
            if (addLineBtn) {
                addLineBtn.addEventListener('click', () => this.addLine());
            }
            
            // Inicializar event listeners en las líneas existentes
            this.initializeExistingLines();
        }
    }
    
    initializeExistingLines() {
        const removeBtns = this.linesBody.querySelectorAll('.remove-line');
        const materialSelects = this.linesBody.querySelectorAll('.material-select');
        const quantityInputs = this.linesBody.querySelectorAll('.quantity');
        const priceInputs = this.linesBody.querySelectorAll('.price');
        
        removeBtns.forEach(btn => {
            const lineNumber = parseInt(btn.getAttribute('data-line'));
            btn.addEventListener('click', () => this.removeLine(lineNumber));
        });
        
        materialSelects.forEach(select => {
            select.addEventListener('change', (e) => this.updateUnit(e));
        });
        
        quantityInputs.forEach(input => {
            input.addEventListener('input', (e) => this.calculateSubtotal(e.target.closest('tr')));
        });
        
        priceInputs.forEach(input => {
            input.addEventListener('input', (e) => this.calculateSubtotal(e.target.closest('tr')));
        });
    }
    
    addLine() {
        this.lineCounter++;
        const lineNumber = this.lineCounter;
        
        const row = document.createElement('tr');
        row.id = `line_${lineNumber}`;
        row.innerHTML = this.getLineHTML(lineNumber);
        
        this.linesBody.appendChild(row);
        this.lineCountInput.value = this.lineCounter;
        
        // Agregar event listeners
        this.attachEventListeners(row, lineNumber);
        this.updateTotal();
    }
    
    getLineHTML(lineNumber) {
        return `
            <td>${lineNumber}</td>
            <td>
                <select class="form-select material-select" name="id_material_${lineNumber}" required>
                    <option value="">Seleccionar material...</option>
                    {% for material in materials %}
                        <option value="{{ material.id_material }}" data-unit="{{ material.unit }}">
                            {{ material.id_material }} - {{ material.name }}
                        </option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <input type="number" class="form-control quantity" name="quantity_${lineNumber}" 
                       min="1" value="1" required>
            </td>
            <td>
                <input type="text" class="form-control unit" name="unit_material_${lineNumber}" 
                       readonly required>
            </td>
            <td>
                <input type="number" class="form-control price" name="price_${lineNumber}" 
                       step="0.01" min="0" value="0" required>
            </td>
            <td>
                <select class="form-select currency" name="currency_suppliers_${lineNumber}" required>
                    <option value="">Seleccionar...</option>
                    {% for currency in currencies %}
                        <option value="{{ currency.symbol }}">
                            {{ currency.symbol }}
                        </option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <span class="subtotal">0.00</span>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger remove-line" 
                        data-line="${lineNumber}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    }
    
    attachEventListeners(row, lineNumber) {
        const materialSelect = row.querySelector('.material-select');
        const quantityInput = row.querySelector('.quantity');
        const priceInput = row.querySelector('.price');
        const removeBtn = row.querySelector('.remove-line');
        
        materialSelect.addEventListener('change', (e) => this.updateUnit(e));
        quantityInput.addEventListener('input', () => this.calculateSubtotal(row));
        priceInput.addEventListener('input', () => this.calculateSubtotal(row));
        removeBtn.addEventListener('click', () => this.removeLine(lineNumber));
    }
    
    removeLine(lineNumber) {
        const row = document.getElementById(`line_${lineNumber}`);
        if (row) {
            row.remove();
            this.updateLineNumbers();
            this.updateTotal();
        }
    }
    
    updateLineNumbers() {
        const rows = this.linesBody.querySelectorAll('tr');
        this.lineCounter = 0;
        
        rows.forEach((row, index) => {
            this.lineCounter++;
            const lineNumber = this.lineCounter;
            row.id = `line_${lineNumber}`;
            
            // Actualizar número
            row.cells[0].textContent = lineNumber;
            
            // Actualizar names de inputs
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.name.split('_').slice(0, -1).join('_');
                input.name = `${name}_${lineNumber}`;
            });
            
            // Actualizar botón remove
            const removeBtn = row.querySelector('.remove-line');
            if (removeBtn) {
                removeBtn.setAttribute('data-line', lineNumber);
            }
        });
        
        this.lineCountInput.value = this.lineCounter;
    }
    
    updateUnit(event) {
        const selectedOption = event.target.options[event.target.selectedIndex];
        const unit = selectedOption.getAttribute('data-unit');
        const row = event.target.closest('tr');
        const unitInput = row.querySelector('.unit');
        
        if (unit) {
            unitInput.value = unit;
        } else {
            unitInput.value = '';
        }
        
        this.calculateSubtotal(row);
    }
    
    calculateSubtotal(row) {
        const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const subtotal = quantity * price;
        
        row.querySelector('.subtotal').textContent = subtotal.toFixed(2);
        this.updateTotal();
    }
    
    updateTotal() {
        let total = 0;
        const subtotals = this.linesBody.querySelectorAll('.subtotal');
        
        subtotals.forEach(subtotal => {
            total += parseFloat(subtotal.textContent) || 0;
        });
        
        this.totalAmountElement.textContent = total.toFixed(2);
        
        // Validar que haya al menos una línea
        if (this.submitBtn) {
            this.submitBtn.disabled = this.lineCounter === 0;
        }
    }
}

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    const currentStatus = "{{ order.status }}";
    
    // Solo inicializar la gestión de líneas si no está en estado Recibida o Cancelada
    if (currentStatus !== 'Recibida' && currentStatus !== 'Cancelada') {
        new PurchaseOrderLines();
    } else {
        // Deshabilitar completamente el botón de enviar si está cancelada
        if (currentStatus === 'Cancelada') {
            const form = document.getElementById('purchaseForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    alert('La orden está cancelada y no puede ser modificada.');
                    return false;
                });
            }
        }
    }
});
</script>
{% endblock %}